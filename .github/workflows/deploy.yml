# .github/workflows/deploy.yml

name: Spring Boot CI/CD to OCI

# 1. 언제 실행할 것인가?
on:
  push:
    branches: [ "main" ] # 'main' 브랜치에 푸시될 때만 실행

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # GitHub Actions가 빌려줄 가상 머신 OS
    
    steps:
      # 1. GitHub 저장소의 코드를 가져옵니다.
      - name: Checkout
        uses: actions/checkout@v3

      # 2. JDK 17 설치 (본인의 버전에 맞게 수정)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Gradle 빌드 (Maven 사용자는 'mvn package' 등으로 변경)
      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew build

      # 4. (CD 시작) SCP로 .jar 파일을 OCI 서버에 전송
      - name: SCP .jar file to OCI
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.OCI_HOST }}         # 1단계에서 등록한 Secret
          username: ${{ secrets.OCI_USERNAME }} # 1단계에서 등록한 Secret
          key: ${{ secrets.OCI_SSH_KEY }}      # 1단계에서 등록한 Secret
          port: 22                             # SSH 포트 (기본 22)
          source: "build/libs/*.jar"           # 로컬(빌드 머신)의 .jar 파일 경로
          target: "~/"                         # OCI 서버에 업로드할 경로 (예: /home/ubuntu)

      # 5. SSH로 OCI 서버에 접속하여 앱 재시작
      - name: Restart Spring Boot app on OCI
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USERNAME }}
          key: ${{ secrets.OCI_SSH_KEY }}
          port: 22
          script: |
            # 이전에 systemd 서비스로 등록한 이름 (my-app.service)을 사용합니다.
            sudo systemctl restart my-app.service
            
            # (선택) Nginx도 재시작해야 하는 경우
            # sudo systemctl restart nginx
